# ARM高负载性能测试

## 测试目的

在x86服务器的认识上，大部分延迟敏感的业务，因为x86使用了超线程技术来扩展并发能力，在cpu大于50%时，容易引起性能下降，因此实际工作负载场景，cpu不能打得太满，一般以控制在40%为宜。而Arm架构因为每个核都是独立核心，因此在高负载场景下，性能应该不会有太大损失，因此进行测试观察是否可以把cpu消耗增加，从而提升性价比。

## 环境准备

```bash
#gcc用于编译，htop用于观察cpu情况
yum install -y gcc htop
#下载主程序
wget https://raw.githubusercontent.com/tansoft/aws-poc/main/graviton-cpu-test/cputest.c
#编译程序，-O0 确保没有进行代码上的优化，确保代码执行的正确性
gcc -lpthread cputest.c -O0 -o cputest
```

## 测试方法

./cputest <thread_count> <use_cpu> <use_method>

* thread_count：指定测试的线程数
* use_cpu：指定这些线程一共可以使用多少个cpu，默认值为1，即只使用单个vCPU。
* use_method：默认值0。
 * 0：使用标准的测试方法，递增运算后sleep，以控制cpu利用率

```bash
#测试单核10线程
./cputest 10

#测试双核10线程
./cputest 10 2

#使用方法1测试8核10线程
./cputest 10 8 1

#批量运行双核方法测试
for i in 1 2 3 4 5 10 15 20 25 30 40 50 60 70 80 90; do ./cputest $i 2; done | grep "mode-"

```

测试过程可以通过htop观察，观察具体cpu核的使用情况，默认主线程会绑定在最后一个核，其他核按参数要求从0号cpu（htop上显示CPU1）开始顺序配置绑定对应的cpu使用。

## 测试数据

| 系列 | 机型 | 系统版本 | gcc版本 | 测试参数 |
| :----: | :----: | :---- | :---- | :---- |
| x86 | m5.xlarge | 5.10.102-99.473.amzn2.x86_64 | 7.3.1 | 1-4核分别测试方法0
| arm | m6g.xlarge | 5.10.102-99.473.amzn2.aarch64 | 7.3.1 | 1-4核分别测试方法0
| x86 | c6i.xlarge | 5.10.102-99.473.amzn2.x86_64 | 7.3.1 | 1-4核分别测试方法0
| arm | c7g.xlarge | 5.10.102-99.473.amzn2.aarch64 | 7.3.1 | 1-4核分别测试方法0

### 单核测试

* 通过单核多线程测试，能看到随着线程数增加，cpu变化是线性增加的。
* m5在40个线程时cpu打满，其他三个类型都可以到70-80线程时cpu打满。
* cpu打满后，耗时会指数上升，m5性能要比其他三款差距较大。
* 执行耗时arm的两款实例都比x86会有10%左右优势。

### 双核测试

* x86上双核使用的是相同的物理核，而arm的双核是独立的两个物理核。
* 在相同的40%cpu占用率，m5可以运行20个线程，其他三个类型可以运行50个线程，且arm的耗时有优势。
* 在CPU负载比较高时（60%-90%），x86由于同物理核超线程避免cpu切换，仅仅在这个场景下，耗时表现会稍好。

### 三核及以上测试

* 在多个物理核的情况下，arm性能会有优势。
* 在相同的cpu占用率情况下，arm能跑更多的线程。
* 由于多核会涉及到cpu物理核间的切换，x86的超线程没有优势。

注：横坐标是压测的线程数

![对比图表](benchmark.png)

### 原始数据

```
m5
mode-x86_64-0-inc-1,1,572081.90,1.68
mode-x86_64-0-inc-1,2,579312.73,5.15
mode-x86_64-0-inc-1,3,571664.85,27.49
mode-x86_64-0-inc-1,4,572817.70,4.13
mode-x86_64-0-inc-1,5,578503.60,8.49
mode-x86_64-0-inc-1,10,607591.28,24.99
mode-x86_64-0-inc-1,15,619979.99,63.16
mode-x86_64-0-inc-1,20,638795.68,36.44
mode-x86_64-0-inc-1,25,697299.82,75.69
mode-x86_64-0-inc-1,30,722457.11,83.48
mode-x86_64-0-inc-1,40,680634.10,100.00
mode-x86_64-0-inc-1,50,862335.07,100.00
mode-x86_64-0-inc-1,60,1061832.61,100.00
mode-x86_64-0-inc-1,70,1256064.10,100.00
mode-x86_64-0-inc-1,80,1455153.26,100.00
mode-x86_64-0-inc-1,90,1670678.91,100.00

mode-x86_64-0-inc-2,1,577956.38,1.11
mode-x86_64-0-inc-2,2,574627.41,2.20
mode-x86_64-0-inc-2,3,558907.58,12.06
mode-x86_64-0-inc-2,4,566763.80,9.75
mode-x86_64-0-inc-2,5,570483.72,8.86
mode-x86_64-0-inc-2,10,583406.05,10.78
mode-x86_64-0-inc-2,15,597454.54,28.15
mode-x86_64-0-inc-2,20,612749.53,32.20
mode-x86_64-0-inc-2,25,628110.39,43.77
mode-x86_64-0-inc-2,30,640709.08,49.34
mode-x86_64-0-inc-2,40,660869.94,59.16
mode-x86_64-0-inc-2,50,694294.63,70.36
mode-x86_64-0-inc-2,60,721427.01,81.29
mode-x86_64-0-inc-2,70,752539.71,92.09
mode-x86_64-0-inc-2,80,799722.36,99.99
mode-x86_64-0-inc-2,90,893989.96,100.00

mode-x86_64-0-inc-3,1,572918.36,0.08
mode-x86_64-0-inc-3,2,568840.33,0.28
mode-x86_64-0-inc-3,3,571947.79,1.48
mode-x86_64-0-inc-3,4,487874.34,2.75
mode-x86_64-0-inc-3,5,488408.33,5.35
mode-x86_64-0-inc-3,10,513186.96,10.11
mode-x86_64-0-inc-3,15,538808.03,16.72
mode-x86_64-0-inc-3,20,553526.38,20.99
mode-x86_64-0-inc-3,25,580935.05,29.62
mode-x86_64-0-inc-3,30,606245.77,35.46
mode-x86_64-0-inc-3,40,648913.20,44.98
mode-x86_64-0-inc-3,50,689736.31,60.23
mode-x86_64-0-inc-3,60,725746.65,70.61
mode-x86_64-0-inc-3,70,761127.98,76.12
mode-x86_64-0-inc-3,80,785518.51,87.27
mode-x86_64-0-inc-3,90,817658.21,98.10

mode-x86_64-0-inc-4,1,561739.04,0.19
mode-x86_64-0-inc-4,2,566814.59,0.11
mode-x86_64-0-inc-4,3,571241.40,1.04
mode-x86_64-0-inc-4,4,575410.19,1.84
mode-x86_64-0-inc-4,5,498163.58,2.45
mode-x86_64-0-inc-4,10,494030.28,7.23
mode-x86_64-0-inc-4,15,539077.75,13.98
mode-x86_64-0-inc-4,20,563114.88,18.86
mode-x86_64-0-inc-4,25,574162.35,23.48
mode-x86_64-0-inc-4,30,593042.38,28.88
mode-x86_64-0-inc-4,40,627726.51,40.40
mode-x86_64-0-inc-4,50,662046.51,51.37
mode-x86_64-0-inc-4,60,697335.83,60.95
mode-x86_64-0-inc-4,70,732288.30,70.61
mode-x86_64-0-inc-4,80,762884.40,77.91
mode-x86_64-0-inc-4,90,791130.83,85.61

m6g
mode-aarch64-0-inc-1,1,538306.50,0.08
mode-aarch64-0-inc-1,2,541217.07,3.32
mode-aarch64-0-inc-1,3,543514.83,7.92
mode-aarch64-0-inc-1,4,545596.55,8.09
mode-aarch64-0-inc-1,5,547673.56,13.81
mode-aarch64-0-inc-1,10,557999.79,31.45
mode-aarch64-0-inc-1,15,570638.33,51.29
mode-aarch64-0-inc-1,20,581911.13,42.06
mode-aarch64-0-inc-1,25,592716.10,63.09
mode-aarch64-0-inc-1,30,606321.60,25.82
mode-aarch64-0-inc-1,40,630315.43,73.37
mode-aarch64-0-inc-1,50,654988.98,77.39
mode-aarch64-0-inc-1,60,681084.73,91.12
mode-aarch64-0-inc-1,70,764650.60,100.00
mode-aarch64-0-inc-1,80,859438.08,100.00
mode-aarch64-0-inc-1,90,968926.90,100.00

mode-aarch64-0-inc-2,1,538645.48,0.02
mode-aarch64-0-inc-2,2,539311.95,0.04
mode-aarch64-0-inc-2,3,520389.57,6.02
mode-aarch64-0-inc-2,4,534359.34,10.16
mode-aarch64-0-inc-2,5,493647.09,8.30
mode-aarch64-0-inc-2,10,537721.34,11.25
mode-aarch64-0-inc-2,15,548464.83,18.51
mode-aarch64-0-inc-2,20,577605.68,21.76
mode-aarch64-0-inc-2,25,596431.84,26.01
mode-aarch64-0-inc-2,30,618176.70,26.27
mode-aarch64-0-inc-2,40,661196.35,43.72
mode-aarch64-0-inc-2,50,704906.52,52.21
mode-aarch64-0-inc-2,60,744596.88,58.05
mode-aarch64-0-inc-2,70,781571.16,58.87
mode-aarch64-0-inc-2,80,814871.78,70.27
mode-aarch64-0-inc-2,90,847678.97,74.84

mode-aarch64-0-inc-3,1,538641.48,0.03
mode-aarch64-0-inc-3,2,540011.00,0.03
mode-aarch64-0-inc-3,3,539350.26,0.17
mode-aarch64-0-inc-3,4,500425.16,2.93
mode-aarch64-0-inc-3,5,459690.84,4.96
mode-aarch64-0-inc-3,10,477760.22,10.84
mode-aarch64-0-inc-3,15,467379.97,21.51
mode-aarch64-0-inc-3,20,492685.53,27.94
mode-aarch64-0-inc-3,25,519164.80,36.70
mode-aarch64-0-inc-3,30,563841.47,36.83
mode-aarch64-0-inc-3,40,623933.94,37.32
mode-aarch64-0-inc-3,50,665068.53,43.90
mode-aarch64-0-inc-3,60,700047.81,50.76
mode-aarch64-0-inc-3,70,731829.31,56.11
mode-aarch64-0-inc-3,80,761091.48,58.05
mode-aarch64-0-inc-3,90,787683.75,63.17

mode-aarch64-0-inc-4,1,538684.40,0.03
mode-aarch64-0-inc-4,2,539512.38,0.05
mode-aarch64-0-inc-4,3,539152.35,0.06
mode-aarch64-0-inc-4,4,538469.51,0.18
mode-aarch64-0-inc-4,5,504009.42,2.79
mode-aarch64-0-inc-4,10,436594.32,8.88
mode-aarch64-0-inc-4,15,461666.10,13.40
mode-aarch64-0-inc-4,20,482438.27,17.98
mode-aarch64-0-inc-4,25,508148.89,22.40
mode-aarch64-0-inc-4,30,532854.68,25.35
mode-aarch64-0-inc-4,40,573778.54,31.72
mode-aarch64-0-inc-4,50,609173.52,37.37
mode-aarch64-0-inc-4,60,639680.95,43.09
mode-aarch64-0-inc-4,70,667927.40,48.58
mode-aarch64-0-inc-4,80,692984.86,54.15
mode-aarch64-0-inc-4,90,716219.55,58.05

c6i
mode-x86_64-0-inc-1,1,563390.34,0.04
mode-x86_64-0-inc-1,2,563446.24,0.20
mode-x86_64-0-inc-1,3,570195.92,9.70
mode-x86_64-0-inc-1,4,571439.32,0.00
mode-x86_64-0-inc-1,5,571443.98,0.00
mode-x86_64-0-inc-1,10,579783.39,0.09
mode-x86_64-0-inc-1,15,588236.18,0.00
mode-x86_64-0-inc-1,20,597023.55,0.41
mode-x86_64-0-inc-1,25,606077.50,1.71
mode-x86_64-0-inc-1,30,615444.76,9.11
mode-x86_64-0-inc-1,40,635706.91,26.52
mode-x86_64-0-inc-1,50,654231.83,75.41
mode-x86_64-0-inc-1,60,678858.22,82.29
mode-x86_64-0-inc-1,70,703588.62,92.91
mode-x86_64-0-inc-1,80,795387.52,100.00
mode-x86_64-0-inc-1,90,900867.24,100.00

mode-x86_64-0-inc-2,1,563405.48,0.02
mode-x86_64-0-inc-2,2,563437.05,0.00
mode-x86_64-0-inc-2,3,578942.05,1.75
mode-x86_64-0-inc-2,4,587100.47,0.02
mode-x86_64-0-inc-2,5,588115.74,1.24
mode-x86_64-0-inc-2,10,588222.82,31.96
mode-x86_64-0-inc-2,15,598637.11,4.84
mode-x86_64-0-inc-2,20,610528.59,1.28
mode-x86_64-0-inc-2,25,614410.37,29.95
mode-x86_64-0-inc-2,30,619320.80,17.46
mode-x86_64-0-inc-2,40,645259.80,33.79
mode-x86_64-0-inc-2,50,670087.42,43.05
mode-x86_64-0-inc-2,60,702638.40,34.73
mode-x86_64-0-inc-2,70,722979.71,55.10
mode-x86_64-0-inc-2,80,745145.12,64.98
mode-x86_64-0-inc-2,90,770075.85,66.59

mode-x86_64-0-inc-3,1,563395.92,0.00
mode-x86_64-0-inc-3,2,566746.73,0.06
mode-x86_64-0-inc-3,3,573913.37,0.05
mode-x86_64-0-inc-3,4,509988.91,0.66
mode-x86_64-0-inc-3,5,520783.71,2.67
mode-x86_64-0-inc-3,10,545249.18,5.31
mode-x86_64-0-inc-3,15,569619.18,8.16
mode-x86_64-0-inc-3,20,586726.29,10.61
mode-x86_64-0-inc-3,25,602297.83,13.81
mode-x86_64-0-inc-3,30,617227.26,16.57
mode-x86_64-0-inc-3,40,648027.56,23.51
mode-x86_64-0-inc-3,50,673160.83,31.44
mode-x86_64-0-inc-3,60,699143.17,38.63
mode-x86_64-0-inc-3,70,724204.08,44.49
mode-x86_64-0-inc-3,80,749887.61,50.25
mode-x86_64-0-inc-3,90,774813.72,56.85

mode-x86_64-0-inc-4,1,563436.68,0.01
mode-x86_64-0-inc-4,2,567319.45,0.01
mode-x86_64-0-inc-4,3,574008.99,0.08
mode-x86_64-0-inc-4,4,579323.39,0.07
mode-x86_64-0-inc-4,5,523243.52,1.55
mode-x86_64-0-inc-4,10,525077.57,3.74
mode-x86_64-0-inc-4,15,548870.82,6.20
mode-x86_64-0-inc-4,20,570237.42,8.49
mode-x86_64-0-inc-4,25,587247.80,11.49
mode-x86_64-0-inc-4,30,601985.47,14.18
mode-x86_64-0-inc-4,40,628829.00,20.11
mode-x86_64-0-inc-4,50,654329.65,26.67
mode-x86_64-0-inc-4,60,677318.45,32.78
mode-x86_64-0-inc-4,70,700455.58,39.18
mode-x86_64-0-inc-4,80,721097.21,44.30
mode-x86_64-0-inc-4,90,741524.45,49.71

c7g
mode-aarch64-0-inc-1,1,534367.96,0.00
mode-aarch64-0-inc-1,2,536521.25,5.26
mode-aarch64-0-inc-1,3,538674.93,4.70
mode-aarch64-0-inc-1,4,539946.18,16.99
mode-aarch64-0-inc-1,5,542112.32,10.22
mode-aarch64-0-inc-1,10,551960.89,20.64
mode-aarch64-0-inc-1,15,562464.37,42.75
mode-aarch64-0-inc-1,20,573002.75,32.38
mode-aarch64-0-inc-1,25,582882.04,33.33
mode-aarch64-0-inc-1,30,591914.80,65.80
mode-aarch64-0-inc-1,40,614375.99,71.05
mode-aarch64-0-inc-1,50,634725.94,62.58
mode-aarch64-0-inc-1,60,660820.22,90.29
mode-aarch64-0-inc-1,70,707327.20,100.00
mode-aarch64-0-inc-1,80,821616.14,100.00
mode-aarch64-0-inc-1,90,900708.67,100.00

mode-aarch64-0-inc-2,1,534627.00,0.00
mode-aarch64-0-inc-2,2,536855.64,0.32
mode-aarch64-0-inc-2,3,515985.46,5.89
mode-aarch64-0-inc-2,4,531891.89,7.38
mode-aarch64-0-inc-2,5,535505.09,9.31
mode-aarch64-0-inc-2,10,535485.45,11.02
mode-aarch64-0-inc-2,15,550967.53,13.46
mode-aarch64-0-inc-2,20,560966.36,15.62
mode-aarch64-0-inc-2,25,581066.08,27.86
mode-aarch64-0-inc-2,30,597917.30,23.41
mode-aarch64-0-inc-2,40,634365.58,39.86
mode-aarch64-0-inc-2,50,671533.06,43.37
mode-aarch64-0-inc-2,60,702280.99,60.26
mode-aarch64-0-inc-2,70,731168.12,61.08
mode-aarch64-0-inc-2,80,757961.67,66.28
mode-aarch64-0-inc-2,90,782461.53,80.15

mode-aarch64-0-inc-3,1,534477.60,0.01
mode-aarch64-0-inc-3,2,536631.47,0.01
mode-aarch64-0-inc-3,3,536413.27,0.04
mode-aarch64-0-inc-3,4,516136.62,3.43
mode-aarch64-0-inc-3,5,462322.23,4.81
mode-aarch64-0-inc-3,10,486634.00,9.36
mode-aarch64-0-inc-3,15,469812.82,17.02
mode-aarch64-0-inc-3,20,496183.58,22.98
mode-aarch64-0-inc-3,25,517388.45,28.96
mode-aarch64-0-inc-3,30,540157.93,35.46
mode-aarch64-0-inc-3,40,602194.97,34.15
mode-aarch64-0-inc-3,50,638590.31,39.73
mode-aarch64-0-inc-3,60,668472.16,44.94
mode-aarch64-0-inc-3,70,696113.82,50.77
mode-aarch64-0-inc-3,80,720370.19,56.22
mode-aarch64-0-inc-3,90,742156.44,60.42

mode-aarch64-0-inc-4,1,534674.80,0.00
mode-aarch64-0-inc-4,2,536617.36,0.04
mode-aarch64-0-inc-4,3,536039.96,0.03
mode-aarch64-0-inc-4,4,535580.65,0.16
mode-aarch64-0-inc-4,5,507266.83,2.46
mode-aarch64-0-inc-4,10,431212.58,7.53
mode-aarch64-0-inc-4,15,456923.67,12.12
mode-aarch64-0-inc-4,20,474827.97,16.48
mode-aarch64-0-inc-4,25,495979.19,20.26
mode-aarch64-0-inc-4,30,518133.66,22.77
mode-aarch64-0-inc-4,40,555522.86,28.45
mode-aarch64-0-inc-4,50,587120.71,34.33
mode-aarch64-0-inc-4,60,613709.12,39.97
mode-aarch64-0-inc-4,70,638264.73,44.98
mode-aarch64-0-inc-4,80,659408.51,50.30
mode-aarch64-0-inc-4,90,679431.52,53.42
```
